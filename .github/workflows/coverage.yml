name: Code Coverage with JaCoCo

on:
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  pull-requests: write

jobs:
  test-and-coverage:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'
    
    - name: Install Maven (for act/local testing)
      if: env.ACT == 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y maven
    
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Run tests with JaCoCo
      run: mvn clean test jacoco:report
        
    - name: Parse JaCoCo CSV Report
      if: github.event_name == 'pull_request'
      id: parse-coverage
      run: |
        # Use the existing read-code-coverage.py script
        COVERAGE_PERCENT=$(python3 .github/scripts/read-code-coverage.py)
        
        # Set the coverage percentage as output
        echo "instruction_percent=$COVERAGE_PERCENT" >> $GITHUB_OUTPUT

    - name: Comment PR with coverage
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const coveragePercent = '${{ steps.parse-coverage.outputs.instruction_percent }}';
          
          // Determine overall coverage status
          const overallCoverage = parseFloat(coveragePercent);
          let statusEmoji = 'üü¢';
          let statusText = 'Good';
          
          if (overallCoverage < 50) {
            statusEmoji = 'üî¥';
            statusText = 'Needs Improvement';
          } else if (overallCoverage < 80) {
            statusEmoji = 'üü°';
            statusText = 'Fair';
          }
          
          const commentBody = `## üìä Code Coverage Report ${statusEmoji}
          
          **Overall Status:** ${statusText}
          
          | Metric | Coverage |
          |--------|----------|
          | **Total Coverage** | **${coveragePercent}%** |
          
          > üìã **Coverage Thresholds**: üü¢ Good (‚â•80%) | üü° Fair (50-79%) | üî¥ Needs Improvement (<50%)  
          > ‚ö†Ô∏è **Required**: Coverage must be ‚â•80% for PR approval
          
          ---
          *Generated by [JaCoCo](https://www.jacoco.org/) ‚Ä¢ [View workflow run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: commentBody
          });
          
    - name: Check coverage threshold
      if: github.event_name == 'pull_request'
      run: |
        COVERAGE_PERCENT=$(python3 .github/scripts/read-code-coverage.py)
        COVERAGE_THRESHOLD=80.00
        
        echo "Current coverage: $COVERAGE_PERCENT%"
        echo "Required threshold: $COVERAGE_THRESHOLD%"
        
        # Convert to integers for comparison (multiply by 100 to avoid decimal issues)
        COVERAGE_INT=$(echo "$COVERAGE_PERCENT * 100" | awk '{printf "%.0f", $1}')
        THRESHOLD_INT=$(echo "$COVERAGE_THRESHOLD * 100" | awk '{printf "%.0f", $1}')
        
        if [ $COVERAGE_INT -lt $THRESHOLD_INT ]; then
          echo "‚ùå Coverage check failed!"
          echo "Current coverage ($COVERAGE_PERCENT%) is below the required threshold ($COVERAGE_THRESHOLD%)"
          echo "Please add more tests to improve code coverage."
          exit 1
        else
          echo "‚úÖ Coverage check passed!"
          echo "Current coverage ($COVERAGE_PERCENT%) meets the required threshold ($COVERAGE_THRESHOLD%)"
        fi
          
    - name: Upload coverage artifacts
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-${{ github.run_number }}
        path: |
          target/site/jacoco/
          target/jacoco.exec
          target/surefire-reports/
        retention-days: 30
